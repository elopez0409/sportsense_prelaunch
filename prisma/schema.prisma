// SportSense V2 - Production NBA Data Schema
// PostgreSQL (Neon) + Prisma ORM

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// CORE NBA DATA MODELS
// ============================================

model League {
  id           String   @id @default(cuid())
  externalId   String   @unique
  name         String
  abbreviation String
  sport        String
  country      String
  logoUrl      String?
  
  seasons      Season[]
  teams        Team[]
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@index([abbreviation])
}

model Season {
  id           String   @id @default(cuid())
  externalId   String   @unique
  leagueId     String
  league       League   @relation(fields: [leagueId], references: [id])
  
  year         Int
  name         String
  startDate    DateTime
  endDate      DateTime
  isCurrent    Boolean  @default(false)
  
  games        Game[]
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@index([year])
  @@index([isCurrent])
}

model Team {
  id              String   @id @default(cuid())
  externalId      String   @unique
  nbaStatsId      String?  @unique
  
  leagueId        String
  league          League   @relation(fields: [leagueId], references: [id])
  
  name            String
  fullName        String
  abbreviation    String
  city            String
  conference      String
  division        String
  
  logoUrl         String?
  primaryColor    String?
  secondaryColor  String?
  
  // Standings
  wins            Int      @default(0)
  losses          Int      @default(0)
  
  players         Player[]
  homeGames       Game[]   @relation("HomeTeam")
  awayGames       Game[]   @relation("AwayTeam")
  
  followers       UserFollow[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([abbreviation])
  @@index([conference])
}

model Player {
  id              String   @id @default(cuid())
  externalId      String   @unique
  nbaStatsId      String?  @unique
  
  teamId          String?
  team            Team?    @relation(fields: [teamId], references: [id])
  
  firstName       String
  lastName        String
  fullName        String
  
  position        String?
  height          String?
  weight          Int?
  
  jerseyNumber    String?
  birthDate       DateTime?
  country         String?
  college         String?
  draftYear       Int?
  draftRound      Int?
  draftPick       Int?
  
  headshotUrl     String?
  isActive        Boolean  @default(true)
  
  gameStats       PlayerGameStats[]
  playInvolvements PlayPlayerInvolvement[]
  followers       UserFollow[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([fullName])
  @@index([teamId])
  @@index([isActive])
}

// ============================================
// GAME & LIVE DATA MODELS
// ============================================

model Game {
  id              String   @id @default(cuid())
  externalId      String   @unique
  nbaStatsId      String?  @unique
  
  seasonId        String
  season          Season   @relation(fields: [seasonId], references: [id])
  
  homeTeamId      String
  homeTeam        Team     @relation("HomeTeam", fields: [homeTeamId], references: [id])
  awayTeamId      String
  awayTeam        Team     @relation("AwayTeam", fields: [awayTeamId], references: [id])
  
  scheduledAt     DateTime
  venue           String?
  
  // Status: SCHEDULED, LIVE, HALFTIME, FINAL, POSTPONED, CANCELLED
  status          String   @default("SCHEDULED")
  period          Int      @default(0)
  gameClock       String?
  isHalftime      Boolean  @default(false)
  
  homeScore       Int      @default(0)
  awayScore       Int      @default(0)
  homeQ1Score     Int?
  homeQ2Score     Int?
  homeQ3Score     Int?
  homeQ4Score     Int?
  homeOTScore     Int?
  awayQ1Score     Int?
  awayQ2Score     Int?
  awayQ3Score     Int?
  awayQ4Score     Int?
  awayOTScore     Int?
  
  attendance      Int?
  nationalTv      String?
  
  plays           Play[]
  playerStats     PlayerGameStats[]
  comments        Comment[]
  aiSummaries     AISummary[]
  momentCards     MomentCard[]
  
  lastSyncAt      DateTime @default(now())
  dataSource      String   @default("balldontlie")
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([scheduledAt])
  @@index([status])
  @@index([homeTeamId])
  @@index([awayTeamId])
  @@index([seasonId])
}

model Play {
  id              String   @id @default(cuid())
  externalId      String?
  
  gameId          String
  game            Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  
  period          Int
  gameClock       String
  eventNum        Int
  
  // PlayType: MADE_SHOT, MISSED_SHOT, FREE_THROW_MADE, etc.
  playType        String
  description     String
  
  homeScore       Int
  awayScore       Int
  scoreChange     Int      @default(0)
  scoringTeamId   String?
  
  players         PlayPlayerInvolvement[]
  
  isBigPlay       Boolean  @default(false)
  isClutch        Boolean  @default(false)
  
  createdAt       DateTime @default(now())
  
  @@unique([gameId, eventNum])
  @@index([gameId, period])
  @@index([playType])
  @@index([isBigPlay])
}

model PlayPlayerInvolvement {
  id        String @id @default(cuid())
  playId    String
  play      Play   @relation(fields: [playId], references: [id], onDelete: Cascade)
  playerId  String
  player    Player @relation(fields: [playerId], references: [id])
  role      String
  
  @@unique([playId, playerId, role])
  @@index([playerId])
}

model PlayerGameStats {
  id              String   @id @default(cuid())
  
  gameId          String
  game            Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  playerId        String
  player          Player   @relation(fields: [playerId], references: [id])
  teamId          String
  
  minutes         String?
  minutesDecimal  Float?
  
  points          Int      @default(0)
  fgm             Int      @default(0)
  fga             Int      @default(0)
  fg3m            Int      @default(0)
  fg3a            Int      @default(0)
  ftm             Int      @default(0)
  fta             Int      @default(0)
  
  oreb            Int      @default(0)
  dreb            Int      @default(0)
  reb             Int      @default(0)
  
  ast             Int      @default(0)
  stl             Int      @default(0)
  blk             Int      @default(0)
  tov             Int      @default(0)
  pf              Int      @default(0)
  
  plusMinus       Int      @default(0)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([gameId, playerId])
  @@index([playerId])
  @@index([gameId])
}

// ============================================
// AI-GENERATED CONTENT
// ============================================

model AISummary {
  id           String   @id @default(cuid())
  
  gameId       String
  game         Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  
  // SummaryType: PREGAME_PREVIEW, HALFTIME_REPORT, FINAL_RECAP, QUARTER_SUMMARY
  summaryType  String
  content      String
  
  dataSnapshot String   // JSON string
  modelUsed    String
  promptUsed   String
  
  generatedAt  DateTime @default(now())
  
  @@unique([gameId, summaryType])
  @@index([summaryType])
}

model MomentCard {
  id           String   @id @default(cuid())
  
  gameId       String
  game         Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  
  triggerType  String
  playId       String?
  
  title        String
  description  String
  significance Int
  
  homeScore    Int
  awayScore    Int
  period       Int
  gameClock    String?
  
  dataSnapshot String   // JSON string
  generatedAt  DateTime @default(now())
  
  @@index([gameId])
  @@index([significance])
}

// ============================================
// USER & SOCIAL MODELS
// ============================================

model User {
  id            String    @id @default(cuid())
  
  email         String    @unique
  emailVerified DateTime?
  passwordHash  String?
  
  name          String?
  username      String?   @unique
  avatarUrl     String?
  bio           String?
  
  karma         Int       @default(0)
  correctPredictions Int  @default(0)
  totalPredictions   Int  @default(0)
  
  accounts      Account[]
  sessions      Session[]
  follows       UserFollow[]
  comments      Comment[]
  reactions     Reaction[]
  notifications Notification[]
  pushSubscriptions PushSubscription[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([username])
  @@index([karma])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  
  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expires      DateTime
  
  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime
  
  @@unique([identifier, token])
}

model UserFollow {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  teamId    String?
  team      Team?    @relation(fields: [teamId], references: [id], onDelete: Cascade)
  playerId  String?
  player    Player?  @relation(fields: [playerId], references: [id], onDelete: Cascade)
  
  notifyGameStart   Boolean @default(true)
  notifyBigPlays    Boolean @default(true)
  notifyFinal       Boolean @default(true)
  
  createdAt DateTime @default(now())
  
  @@unique([userId, teamId])
  @@unique([userId, playerId])
  @@index([userId])
  @@index([teamId])
  @@index([playerId])
}

model Comment {
  id        String   @id @default(cuid())
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  gameId    String
  game      Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  
  content   String
  
  parentId  String?
  parent    Comment? @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Comment[] @relation("CommentReplies")
  
  reactions Reaction[]
  
  isHidden  Boolean  @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([gameId, createdAt])
  @@index([userId])
  @@index([parentId])
}

model Reaction {
  id        String   @id @default(cuid())
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  commentId String
  comment   Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  
  // ReactionType: LIKE, FIRE, COLD, MIND_BLOWN, CLAP
  type      String
  
  createdAt DateTime @default(now())
  
  @@unique([userId, commentId])
  @@index([commentId])
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id        String   @id @default(cuid())
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // NotificationType: GAME_START, BIG_PLAY, CLOSE_GAME, FINAL_SCORE, COMMENT_REPLY, NEW_FOLLOWER
  type      String
  title     String
  body      String
  data      String?  // JSON string
  
  isRead    Boolean  @default(false)
  
  createdAt DateTime @default(now())
  
  @@index([userId, isRead])
  @@index([createdAt])
}

model PushSubscription {
  id        String   @id @default(cuid())
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  endpoint  String   @unique
  p256dh    String
  auth      String
  
  createdAt DateTime @default(now())
  
  @@index([userId])
}

// ============================================
// SYSTEM / OPERATIONAL
// ============================================

model SyncLog {
  id         String   @id @default(cuid())
  
  syncType   String
  status     String
  
  recordsProcessed Int @default(0)
  errors     String?  // JSON string
  
  startedAt  DateTime @default(now())
  completedAt DateTime?
  
  @@index([syncType, startedAt])
}

model RateLimitLog {
  id         String   @id @default(cuid())
  
  apiSource  String
  endpoint   String
  
  requestAt  DateTime @default(now())
  responseMs Int
  statusCode Int
  wasLimited Boolean  @default(false)
  
  @@index([apiSource, requestAt])
}
